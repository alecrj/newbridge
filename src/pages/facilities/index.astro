---
// src/pages/facilities/index.astro — NewBridge Living Facilities (astonishing, themed)
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';

const facilities = await getCollection('facilities').catch(() => []);

// Derived collections
const accepting = facilities.filter((f) => f.data.availability === 'accepting');
const waitlist = facilities.filter((f) => f.data.availability === 'waitlist');
const full = facilities.filter((f) => f.data.availability === 'full');

// Counts
const totalHomes = facilities.length;
const acceptingCount = accepting.length;
const waitlistCount = waitlist.length;
const fullCount = full.length;

// Sort: accepting → waitlist → full, then by name
const availabilityOrder = { accepting: 0, waitlist: 1, full: 2 } as const;
const facilitiesSorted = [...facilities].sort((a, b) => {
  const avA = availabilityOrder[(a.data.availability || 'waitlist') as keyof typeof availabilityOrder] ?? 99;
  const avB = availabilityOrder[(b.data.availability || 'waitlist') as keyof typeof availabilityOrder] ?? 99;
  if (avA !== avB) return avA - avB;
  return String(a.data.facilityName || '').localeCompare(String(b.data.facilityName || ''));
});

const PHONE_DISPLAY = '(850) 555-HOPE';
const PHONE_TEL = 'tel:+18505554673';

const availabilityText = acceptingCount > 0
  ? `${acceptingCount} home${acceptingCount === 1 ? '' : 's'} accepting`
  : (waitlistCount > 0 ? 'Waitlist available' : 'Join the interest list');
---

<BaseLayout
  title="Sober Living Facilities | NewBridge Living — Tallahassee, FL"
  description="View our sober living homes in Tallahassee. Professionally managed, structured environment, and accountability. Confidential intake."
>
  <!-- Skip link -->
  <a href="#list" class="sr-only focus:not-sr-only focus:fixed focus:top-2 focus:left-2 focus:z-50 focus:rounded-md focus:bg-white focus:px-3 focus:py-2 focus:shadow">Skip to listings</a>

  <!-- Announcement / availability bar -->
  <section aria-label="Availability notice" class="bg-emerald-50 text-emerald-900 border-b border-emerald-100">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-2 flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
      <p class="text-sm font-medium"><strong>Now accepting applications</strong><span class="mx-2 text-emerald-700">•</span>{availabilityText}</p>
      <div class="flex items-center gap-3">
        <a href="/contact" class="inline-flex items-center rounded-lg bg-emerald-700 px-3 py-1.5 text-sm font-semibold text-white hover:bg-emerald-800 transition">Apply now</a>
        <a href={PHONE_TEL} class="text-sm font-semibold text-emerald-800 hover:underline">{PHONE_DISPLAY}</a>
      </div>
    </div>
  </section>

  <!-- HERO -->
  <header class="relative overflow-hidden">
    <!-- Background (matches homepage) -->
    <div class="absolute inset-0" style="
      background:
        radial-gradient(1200px 600px at 10% -10%, rgba(16,185,129,.25), transparent 60%),
        radial-gradient(900px 500px at 110% 20%, rgba(45,212,191,.20), transparent 60%),
        linear-gradient(180deg, #064e3b 0%, #065f46 35%, #064e3b 100%);
    "></div>
    <div class="absolute inset-0 opacity-[0.06] mix-blend-soft-light pointer-events-none" style="background-image:url('data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22128%22 height=%22128%22><filter id=%22n%22><feTurbulence type=%22fractalNoise%22 baseFrequency=%220.8%22 numOctaves=%222%22 stitchTiles=%22stitch%22/></filter><rect width=%22100%%22 height=%22100%%22 filter=%22url(%23n)%22 opacity=%220.6%22/></svg>'); background-size: 256px 256px;"></div>

    <div class="relative z-10 max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pt-20 pb-16 sm:pt-28">
      <div class="text-center max-w-4xl mx-auto">
        <span class="inline-flex items-center gap-2 rounded-full border border-emerald-300/30 bg-white/10 px-4 py-2 text-sm font-medium text-emerald-100 backdrop-blur">
          <svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16Zm3.857-9.809a.75.75 0 00-1.214-.882l-3.483 4.79L7.4 10.4a.75.75 0 10-1.2.9l2.25 3a.75.75 0 001.2 0l4.207-5.109z" clip-rule="evenodd"/></svg>
          Quality sober living in Tallahassee
        </span>
        <h1 class="mt-6 text-4xl md:text-6xl font-extrabold leading-tight tracking-tight text-white">Our <span class="bg-gradient-to-r from-emerald-300 to-teal-300 bg-clip-text text-transparent">Facilities</span></h1>
        <p class="mt-6 text-xl text-emerald-100/90">Clean, safe, structured homes designed to support real recovery — not chaos. Tour one, pick your bed, get your routine back.</p>
        <div class="mt-8 flex flex-wrap justify-center gap-4">
          <a href="#list" class="group inline-flex items-center justify-center rounded-xl bg-white px-7 py-4 font-semibold text-emerald-900 shadow-lg shadow-emerald-900/20 transition hover:-translate-y-0.5 hover:shadow-xl">
            View homes
            <svg class="ml-2 h-5 w-5 transition group-hover:translate-x-0.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true"><path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg>
          </a>
          <a href={PHONE_TEL} class="inline-flex items-center justify-center rounded-xl border border-emerald-300/40 bg-white/5 px-7 py-4 font-semibold text-white backdrop-blur transition hover:bg-white/10">Call {PHONE_DISPLAY}</a>
        </div>

        <!-- Stats -->
        <div class="mx-auto mt-12 grid w-full max-w-4xl grid-cols-1 gap-4 sm:grid-cols-3">
          <div class="rounded-xl border border-white/10 bg-white/5 p-5 text-center text-emerald-50"><div class="text-sm opacity-80">Total Homes</div><div class="mt-1 text-3xl font-bold">{totalHomes}</div></div>
          <div class="rounded-xl border border-white/10 bg-white/5 p-5 text-center text-emerald-50"><div class="text-sm opacity-80">Accepting</div><div class="mt-1 text-3xl font-bold">{acceptingCount}</div></div>
          <div class="rounded-xl border border-white/10 bg-white/5 p-5 text-center text-emerald-50"><div class="text-sm opacity-80">Waitlist/Full</div><div class="mt-1 text-3xl font-bold">{waitlistCount + fullCount}</div></div>
        </div>
      </div>
    </div>
  </header>

  <main>
    <!-- Filters / Search -->
    <section class="bg-white py-8 border-b border-gray-100">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
          <div class="flex flex-wrap items-center gap-2" role="tablist" aria-label="Filter by availability">
            <button data-filter="all" class="filter-chip is-active">All ({totalHomes})</button>
            <button data-filter="accepting" class="filter-chip">Accepting ({acceptingCount})</button>
            <button data-filter="waitlist" class="filter-chip">Waitlist ({waitlistCount})</button>
            <button data-filter="full" class="filter-chip">Full ({fullCount})</button>
          </div>
          <div class="relative">
            <svg class="pointer-events-none absolute left-3 top-1/2 -translate-y-1/2 h-5 w-5 text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M21 21l-4.35-4.35M11 19a8 8 0 100-16 8 8 0 000 16z"/></svg>
            <input id="facility-search" type="search" placeholder="Search by name or location" class="pl-10 pr-3 py-2 w-full md:w-80 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500" />
          </div>
        </div>
      </div>
    </section>

    <!-- Facilities list -->
    <section id="list" class="py-16 bg-gray-50">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        {facilitiesSorted.length > 0 ? (
          <div class="grid grid-cols-1 gap-6 md:grid-cols-2 xl:grid-cols-3">
            {facilitiesSorted.map((facility) => {
              const { facilityName, slug, monthlyRent, capacity, location, images = [], description, availability } = facility.data as any;
              const img = (images && images[0]) || '/images/facilities/placeholder.jpg';
              return (
                <article
                  data-card
                  data-name={String(facilityName || '')}
                  data-location={String(location || '')}
                  data-availability={String(availability || '')}
                  class="overflow-hidden rounded-2xl border border-gray-200 bg-white shadow-sm transition hover:shadow-md"
                >
                  <div class="relative bg-gradient-to-br from-emerald-100 to-teal-100">
                    <img src={img} alt={facilityName} class="h-56 w-full object-cover" loading="lazy" onerror="this.style.display='none'" />
                    <div class="absolute inset-0 flex items-start justify-between p-4">
                      <span class={`rounded-full px-3 py-1 text-xs font-semibold
                        ${availability === 'accepting' ? 'bg-green-100 text-green-800' : availability === 'waitlist' ? 'bg-yellow-100 text-yellow-800' : 'bg-red-100 text-red-800'}`}>
                        {availability === 'accepting' ? 'Available' : availability === 'waitlist' ? 'Waitlist' : 'Full'}
                      </span>
                      {capacity && (
                        <span class="rounded-full bg-white/90 px-3 py-1 text-xs font-semibold text-gray-800 border border-gray-200">Cap. {capacity}</span>
                      )}
                    </div>
                  </div>

                  <div class="p-6">
                    <div class="flex items-start justify-between gap-4">
                      <div>
                        <h3 class="text-lg font-semibold text-gray-900">{facilityName}</h3>
                        <p class="mt-1 text-sm text-gray-600">{location}</p>
                      </div>
                      {monthlyRent && (
                        <div class="text-right">
                          <div class="text-lg font-bold text-emerald-700">{monthlyRent}</div>
                          <div class="text-xs text-gray-500">per month</div>
                        </div>
                      )}
                    </div>

                    {description && <p class="mt-3 text-gray-700 line-clamp-3">{description}</p>}

                    <div class="mt-6 flex gap-3">
                      <a href={`/facilities/${facility.data.slug}`} class="inline-flex flex-1 items-center justify-center rounded-lg bg-emerald-600 px-4 py-3 font-semibold text-white transition hover:bg-emerald-700">Learn more</a>
                      <a href="/contact" class="inline-flex items-center justify-center rounded-lg border border-emerald-300 bg-white px-4 py-3 font-semibold text-emerald-700 transition hover:bg-emerald-50">Apply</a>
                    </div>
                  </div>
                </article>
              );
            })}
          </div>
        ) : (
          <div class="text-center py-16">
            <div class="bg-white rounded-2xl border border-gray-200 p-12 max-w-2xl mx-auto shadow-sm">
              <svg class="w-14 h-14 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"></path></svg>
              <h3 class="text-xl font-bold text-gray-900 mb-2">No facilities yet</h3>
              <p class="text-gray-600 mb-6">Add your first sober living facility in the admin to populate this page.</p>
              <a href="/admin" class="inline-flex items-center rounded-xl bg-emerald-600 px-6 py-3 font-semibold text-white hover:bg-emerald-700"><svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>Add facility</a>
            </div>
          </div>
        )}
      </div>
    </section>

    <!-- Final CTA -->
    <section class="bg-emerald-900 py-20 text-white">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 text-center">
        <h2 class="text-3xl sm:text-4xl font-bold">Questions about openings or move‑in?</h2>
        <p class="mt-4 text-emerald-100/90">We’ll give you straight answers. No pressure, no games.</p>
        <div class="mt-8 flex flex-col items-center justify-center gap-4 sm:flex-row">
          <a href={PHONE_TEL} class="group inline-flex items-center justify-center rounded-xl bg-white px-7 py-4 font-semibold text-emerald-900 shadow-lg shadow-emerald-900/20 transition hover:-translate-y-0.5 hover:shadow-xl">
            <svg class="mr-2 h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true"><path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M22 16.92v3a2 2 0 01-2.18 2A19.79 19.79 0 013 5.18 2 2 0 015 3h3a2 2 0 012 1.72c.12.9.3 1.77.54 2.61a2 2 0 01-.45 2.11L9 10a16 16 0 007 7l.56-1.09a2 2 0 012.11-.45c.84.24 1.71.42 2.61.54A2 2 0 0122 16.92z"/></svg>
            Call {PHONE_DISPLAY}
          </a>
          <a href="/contact" class="inline-flex items-center justify-center rounded-xl border border-emerald-300/40 bg-white/5 px-7 py-4 font-semibold text-white backdrop-blur transition hover:bg-white/10">Send message</a>
        </div>
      </div>
    </section>
  </main>

  <!-- Sticky mobile call bar -->
  <div class="fixed bottom-3 inset-x-3 z-40 sm:hidden">
    <a href={PHONE_TEL} class="flex items-center justify-center gap-2 rounded-xl bg-emerald-600 px-4 py-3 text-base font-semibold text-white shadow-lg shadow-emerald-900/20">
      <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-width="2" stroke-linecap="round" stroke-linejoin="round" d="M22 16.92v3a2 2 0 01-2.18 2A19.79 19.79 0 013 5.18 2 2 0 015 3h3a2 2 0 012 1.72c.12.9.3 1.77.54 2.61a2 2 0 01-.45 2.11L9 10a16 16 0 007 7l.56-1.09a2 2 0 012.11-.45c.84.24 1.71.42 2.61.54A2 2 0 0122 16.92z"/></svg>
      Call {PHONE_DISPLAY}
    </a>
  </div>

  <!-- JSON-LD ItemList for facilities (best-effort with relative URLs) -->
  {facilitiesSorted.length > 0 && (
    <script type="application/ld+json">{JSON.stringify({
      '@context': 'https://schema.org',
      '@type': 'ItemList',
      itemListElement: facilitiesSorted.map((f, i) => ({
        '@type': 'ListItem',
        position: i + 1,
        url: `/facilities/${f.data.slug}`,
        name: f.data.facilityName
      }))
    })}</script>
  )}
</BaseLayout>

<style>
  .line-clamp-3{display:-webkit-box;-webkit-line-clamp:3;-webkit-box-orient:vertical;overflow:hidden}
  .filter-chip{--ring:rgba(16,185,129,.35);padding:.5rem .75rem;border-radius:.75rem;border:1px solid #e5e7eb;background:#fff;color:#065f46;font-weight:600;font-size:.875rem}
  .filter-chip:hover{background:#f0fdf4}
  .filter-chip.is-active{border-color:#a7f3d0;box-shadow:0 0 0 3px var(--ring)}
</style>

<script>
  // Tiny client-side filtering & search (no framework)
  (function(){
    const chips = Array.from(document.querySelectorAll('[data-filter]'));
    const search = document.getElementById('facility-search');
    const cards = Array.from(document.querySelectorAll('[data-card]'));
    let current = 'all';

    function apply(){
      const q = (search?.value || '').toLowerCase().trim();
      cards.forEach(card=>{
        const avail = card.getAttribute('data-availability') || '';
        const name = (card.getAttribute('data-name') || '').toLowerCase();
        const location = (card.getAttribute('data-location') || '').toLowerCase();
        const matchAvail = current==='all' || avail===current;
        const matchText = !q || name.includes(q) || location.includes(q);
        card.style.display = (matchAvail && matchText) ? '' : 'none';
      });
    }

    chips.forEach(btn=>{
      btn.addEventListener('click',()=>{
        chips.forEach(c=>c.classList.remove('is-active'));
        btn.classList.add('is-active');
        current = btn.getAttribute('data-filter') || 'all';
        apply();
      });
    });

    search?.addEventListener('input', apply);
  })();
</script>
