---
// src/components/SimpleAuth.astro - Fixed CSS conflicts and enhanced design
const { requiredRole = 'staff' } = Astro.props;
---

<!-- Authentication Check -->
<div
  id="auth-check"
  class="fixed inset-0 z-50 flex items-center justify-center bg-gradient-to-br from-emerald-900 via-emerald-800 to-teal-900"
>
  <div class="text-center">
    <div class="relative mb-6">
      <!-- Animated logo background -->
      <div
        class="mx-auto flex h-20 w-20 items-center justify-center rounded-full bg-white/10 backdrop-blur-sm"
      >
        <div
          class="flex h-16 w-16 animate-pulse items-center justify-center rounded-full bg-gradient-to-br from-emerald-400 to-teal-400"
        >
          <span class="text-xl font-bold text-white">NB</span>
        </div>
      </div>
      <!-- Spinner overlay -->
      <div class="absolute inset-0 flex items-center justify-center">
        <div class="h-24 w-24 animate-spin rounded-full border-2 border-white/20 border-t-white/60">
        </div>
      </div>
    </div>
    <h2 class="mb-2 text-2xl font-bold text-white">üîí Authenticating Access</h2>
    <p class="font-medium text-emerald-200">Verifying NewBridge Living CRM credentials...</p>
    <div class="mx-auto mt-4 w-48">
      <div class="h-2 overflow-hidden rounded-full bg-white/20">
        <div class="h-full w-full animate-pulse bg-gradient-to-r from-emerald-400 to-teal-400">
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Login Modal - FIXED: No more hidden/flex conflicts -->
<div
  id="login-modal"
  class="invisible fixed inset-0 z-50 flex items-center justify-center bg-black/60 p-4 opacity-0 backdrop-blur-sm transition-all duration-300"
>
  <div
    class="w-full max-w-md scale-95 transform rounded-3xl bg-white p-8 shadow-2xl transition-transform duration-300"
    id="modal-content"
  >
    <div class="mb-8 text-center">
      <!-- Enhanced logo -->
      <div
        class="mx-auto mb-6 flex h-20 w-20 items-center justify-center rounded-full bg-gradient-to-br from-emerald-100 to-teal-100 shadow-lg"
      >
        <div
          class="flex h-16 w-16 items-center justify-center rounded-full bg-gradient-to-br from-emerald-500 to-teal-500"
        >
          <span class="text-xl font-bold text-white">NB</span>
        </div>
      </div>
      <h2 class="mb-3 text-3xl font-bold text-gray-900">üè† NewBridge Living</h2>
      <p class="font-medium text-gray-600">Staff Portal Access</p>
      <div class="mx-auto mt-4 h-1 w-20 rounded-full bg-gradient-to-r from-emerald-500 to-teal-500">
      </div>
    </div>

    <button
      id="login-btn"
      class="group flex w-full transform items-center justify-center rounded-2xl bg-gradient-to-r from-emerald-600 to-teal-600 px-6 py-4 font-bold text-white shadow-lg transition-all duration-300 hover:scale-105 hover:from-emerald-700 hover:to-teal-700 hover:shadow-emerald-500/25"
    >
      <svg
        class="mr-3 h-6 w-6 transition-transform duration-300 group-hover:rotate-12"
        fill="none"
        stroke="currentColor"
        viewBox="0 0 24 24"
      >
        <path
          stroke-linecap="round"
          stroke-linejoin="round"
          stroke-width="2"
          d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1"
        ></path>
      </svg>
      Secure Login with Netlify Identity
    </button>

    <div
      class="mt-6 rounded-2xl border border-emerald-200 bg-gradient-to-r from-emerald-50 to-teal-50 p-4"
    >
      <div class="flex items-center justify-center space-x-2 text-emerald-700">
        <svg class="h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path
            stroke-linecap="round"
            stroke-linejoin="round"
            stroke-width="2"
            d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"
          ></path>
        </svg>
        <span class="text-sm font-semibold">HIPAA Compliant ‚Ä¢ Staff Only</span>
      </div>
    </div>
  </div>
</div>

<script>
  // Enhanced authentication with smooth transitions
  function checkAuth() {
    console.log('üîç Checking authentication...');

    if (typeof window.netlifyIdentity !== 'undefined') {
      const user = window.netlifyIdentity.currentUser();

      if (user) {
        hideAuthCheck();
        console.log('‚úÖ User authenticated:', user.email);
      } else {
        showLoginModal();
      }
    } else {
      loadNetlifyIdentity();
    }
  }

  function loadNetlifyIdentity() {
    console.log('üì± Loading Netlify Identity...');

    const script = document.createElement('script');
    script.src = 'https://identity.netlify.com/v1/netlify-identity-widget.js';
    script.onload = function () {
      console.log('‚úÖ Netlify Identity loaded');

      window.netlifyIdentity.on('init', function (user) {
        if (user) {
          hideAuthCheck();
          console.log('üë§ User already logged in:', user.email);
        } else {
          showLoginModal();
        }
      });

      window.netlifyIdentity.on('login', function () {
        console.log('üéâ User logged in successfully');
        hideAuthCheck();
        window.location.reload();
      });

      window.netlifyIdentity.on('logout', function () {
        console.log('üëã User logged out');
        window.location.href = '/';
      });
    };

    document.head.appendChild(script);
  }

  function hideAuthCheck() {
    const authCheck = document.getElementById('auth-check');
    const loginModal = document.getElementById('login-modal');

    if (authCheck) {
      authCheck.style.opacity = '0';
      setTimeout(() => (authCheck.style.display = 'none'), 300);
    }
    if (loginModal) {
      loginModal.style.opacity = '0';
      loginModal.style.visibility = 'hidden';
    }
  }

  function showLoginModal() {
    const authCheck = document.getElementById('auth-check');
    const loginModal = document.getElementById('login-modal');
    const modalContent = document.getElementById('modal-content');

    if (authCheck) {
      authCheck.style.opacity = '0';
      setTimeout(() => (authCheck.style.display = 'none'), 300);
    }

    if (loginModal && modalContent) {
      setTimeout(() => {
        loginModal.style.opacity = '1';
        loginModal.style.visibility = 'visible';
        modalContent.style.transform = 'scale(1)';
      }, 350);
    }
  }

  // Set up login button with enhanced interactions
  document.addEventListener('DOMContentLoaded', function () {
    const loginBtn = document.getElementById('login-btn');

    if (loginBtn) {
      loginBtn.addEventListener('click', function () {
        if (window.netlifyIdentity) {
          window.netlifyIdentity.open();
        } else {
          console.log('‚è≥ Netlify Identity not loaded yet');
          // Show loading state
          loginBtn.innerHTML = `
          <svg class="w-5 h-5 mr-2 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
          </svg>
          Loading...
        `;
        }
      });
    }

    // Start auth check
    checkAuth();
  });
</script>

<style>
  /* Enhanced animations */
  @keyframes spin {
    from {
      transform: rotate(0deg);
    }
    to {
      transform: rotate(360deg);
    }
  }

  @keyframes pulse {
    0%,
    100% {
      opacity: 1;
    }
    50% {
      opacity: 0.7;
    }
  }

  .animate-spin {
    animation: spin 1s linear infinite;
  }

  .animate-pulse {
    animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
  }

  /* Mobile responsive improvements */
  @media (max-width: 640px) {
    #login-modal > div {
      margin: 1rem;
      padding: 2rem 1.5rem;
      border-radius: 1.5rem;
    }

    #login-modal h2 {
      font-size: 1.75rem;
    }

    #login-modal button {
      padding: 1rem 1.5rem;
      font-size: 1rem;
    }
  }

  /* Focus states for accessibility */
  #login-btn:focus-visible {
    outline: none;
    ring: 2px solid rgba(16, 185, 129, 0.5);
    ring-offset: 2px;
  }

  /* Smooth backdrop blur */
  #login-modal {
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
  }
</style>
